# Release Automation Setup Guide

This guide walks through the complete setup process for daft's automated release system using cargo-dist, Homebrew, and cross-platform distribution.

## Overview

The release system automatically:
- Builds binaries for macOS (Intel + Apple Silicon) and Windows
- Creates installers (PowerShell, MSI)
- Generates and updates Homebrew formula
- Creates GitHub Releases with all artifacts
- All triggered by pushing a version tag

## Prerequisites

- ✅ Repository owner/admin access
- ✅ cargo-dist installed and configured (already done)
- ✅ GitHub account with repository access

## Step 1: Configure GitHub Secrets

The automated release workflow requires one GitHub secret for Homebrew formula updates.

### Create Personal Access Token

1. **Go to GitHub Settings**
   - Click your profile picture → Settings
   - Scroll to "Developer settings" (bottom left)
   - Click "Personal access tokens" → "Tokens (classic)"

2. **Generate New Token**
   - Click "Generate new token (classic)"
   - **Note**: `daft-homebrew-updater`
   - **Expiration**: Choose "No expiration" or "1 year" (you'll need to renew)

3. **Select Scopes**
   - ✅ `repo` (all sub-options under Repository)
     - This allows the workflow to commit the updated formula

4. **Generate and Copy**
   - Click "Generate token"
   - **IMPORTANT**: Copy the token immediately (you won't see it again!)
   - Format: `ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

### Add Secret to Repository

1. **Navigate to Repository Settings**
   - Go to https://github.com/avihut/daft
   - Click "Settings" tab
   - Click "Secrets and variables" → "Actions"

2. **Add New Secret**
   - Click "New repository secret"
   - **Name**: `HOMEBREW_TAP_TOKEN`
   - **Secret**: Paste the personal access token
   - Click "Add secret"

3. **Verify**
   - You should see `HOMEBREW_TAP_TOKEN` in the list of secrets
   - The value will be masked

### Security Note

**Important:** This token has write access to your repository. Keep it secure:
- ✅ Never commit it to code
- ✅ Never share it
- ✅ Rotate it periodically (e.g., yearly)
- ✅ Revoke it if compromised

## Step 2: Prepare for First Release

Before creating the first release, we need to handle the Homebrew formula customization.

### Create Placeholder Formula (Optional)

You can create a placeholder formula that cargo-dist will update, or let cargo-dist create it from scratch on the first release.

**Option A: Let cargo-dist create it (recommended)**
- Just make sure `Formula/` directory exists (✅ already done)
- cargo-dist will generate the initial formula on first release
- You'll manually add symlinks after the first release

**Option B: Create placeholder now**

Create `Formula/daft.rb`:

```ruby
class Daft < Formula
  desc "Git extensions toolkit for efficient branch management with worktrees"
  homepage "https://github.com/avihut/daft"
  version "0.1.0"
  license "MIT"

  # This will be populated by cargo-dist on first release
  def install
    bin.install "daft"
  end

  test do
    system "#{bin}/daft", "--version"
  end
end
```

## Step 3: Verify Configuration Files

Ensure all configuration is correct:

### dist-workspace.toml

```toml
[dist]
cargo-dist-version = "0.30.0"
ci = "github"
installers = ["homebrew", "powershell", "msi"]
targets = ["aarch64-apple-darwin", "x86_64-apple-darwin", "x86_64-pc-windows-msvc"]
pr-run-mode = "plan"
publish-jobs = ["homebrew"]
tap = "avihut/homebrew-tap"
formula = "Formula/daft.rb"
```

### Cargo.toml

```toml
[package]
name = "daft"
version = "0.1.0"  # This will be your first release version
homepage = "https://github.com/avihut/daft"
repository = "https://github.com/avihut/daft"
# ... other fields
```

### .github/workflows/release.yml

✅ Auto-generated by cargo-dist
✅ Should exist and reference `HOMEBREW_TAP_TOKEN`

Verify line 297:
```yaml
token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
```

## Step 4: Pre-Release Testing

Test the release process locally before pushing a tag.

### Local Build Test

```bash
# Test building for current platform
cargo dist build --target=aarch64-apple-darwin --artifacts=local

# Verify artifacts
ls -lh target/distrib/

# Check tarball contents
tar -tzf target/distrib/daft-aarch64-apple-darwin.tar.xz

# Should include:
# - daft (binary)
# - README.md
# - LICENSE
```

### Quality Checks

```bash
# All tests pass
mise run test

# No clippy warnings
mise run clippy

# Formatting correct
mise run fmt-check

# Build succeeds
mise run build
```

## Step 5: Create First Release

### Update Version (if needed)

If you want to release a different version than `0.1.0`:

```bash
# Edit Cargo.toml
vim Cargo.toml
# Change: version = "0.1.0" to version = "1.0.0" (or whatever)
```

### Create Changelog (Recommended)

Create `CHANGELOG.md`:

```markdown
# Changelog

All notable changes to this project will be documented in this file.

## [0.1.0] - 2025-10-19

### Added
- Initial release
- Git worktree workflow commands:
  - `git-worktree-clone`: Clone with worktree structure
  - `git-worktree-init`: Initialize new repository
  - `git-worktree-checkout`: Checkout existing branch to new worktree
  - `git-worktree-checkout-branch`: Create new branch and worktree
  - `git-worktree-checkout-branch-from-default`: Branch from default
  - `git-worktree-prune`: Clean up deleted branches
- Multicall binary architecture (single 589KB binary)
- Shell completions for bash, zsh, fish
- Homebrew formula for macOS installation
- Windows support (PowerShell installer, MSI)
- Cross-platform builds (macOS Intel/ARM, Windows)

[0.1.0]: https://github.com/avihut/daft/releases/tag/v0.1.0
```

### Commit and Tag

```bash
# Stage changes
git add Cargo.toml CHANGELOG.md

# Commit
git commit -m "chore: prepare for v0.1.0 release"

# Create tag
git tag v0.1.0

# Push everything
git push origin main
git push origin v0.1.0
```

### Monitor Release

1. **Watch GitHub Actions**
   - Go to https://github.com/avihut/daft/actions
   - You should see a "Release" workflow running
   - It takes approximately 8-12 minutes

2. **Check Progress**
   - ✅ **plan** job: Determines what to build (~1 min)
   - ✅ **build-local-artifacts** jobs: Builds for each platform (~3-5 min each, parallel)
   - ✅ **host** job: Creates GitHub Release (~1 min)
   - ✅ **publish-homebrew-formula** job: Updates formula (~1 min)
   - ✅ **announce** job: Finalizes release (~30 sec)

3. **Verify Release Created**
   - Check https://github.com/avihut/daft/releases
   - Should see "v0.1.0" release with artifacts:
     - `daft-aarch64-apple-darwin.tar.xz`
     - `daft-x86_64-apple-darwin.tar.xz`
     - `daft-x86_64-pc-windows-msvc.zip`
     - `daft-installer.ps1`
     - `daft-installer.msi`
     - `SHA256SUMS`

4. **Verify Formula Updated**
   - Check `Formula/daft.rb` in repository
   - Should be updated with:
     - Version: `0.1.0`
     - SHA256 checksums
     - Download URLs

## Step 6: Post-Release Customization

After the first release, you need to manually customize the Homebrew formula to add symlinks.

### Update Formula/daft.rb

Edit `Formula/daft.rb` and modify the `install` block:

```ruby
def install
  bin.install "daft"

  # Create symlinks for multicall binary
  bin.install_symlink bin/"daft" => "git-worktree-clone"
  bin.install_symlink bin/"daft" => "git-worktree-checkout"
  bin.install_symlink bin/"daft" => "git-worktree-checkout-branch"
  bin.install_symlink bin/"daft" => "git-worktree-checkout-branch-from-default"
  bin.install_symlink bin/"daft" => "git-worktree-init"
  bin.install_symlink bin/"daft" => "git-worktree-prune"
  bin.install_symlink bin/"daft" => "git-daft"

  # Install shell completions (if available)
  bash_completion.install "completions/daft.bash" if File.exist?("completions/daft.bash")
  zsh_completion.install "completions/_daft" if File.exist?("completions/_daft")
  fish_completion.install "completions/daft.fish" if File.exist?("completions/daft.fish")
end
```

Add optional `caveats` block:

```ruby
def caveats
  <<~EOS
    daft is now installed! Git worktree commands are available:
      git worktree-clone <repo>
      git worktree-checkout <branch>
      git worktree-checkout-branch <new-branch>
      git worktree-init <repo-name>
      git worktree-prune

    Run 'git daft' for full documentation.
  EOS
end
```

### Commit Formula Customization

```bash
git add Formula/daft.rb
git commit -m "feat: add symlinks and completions to Homebrew formula"
git push origin main
```

**Note:** This customization will be preserved on future releases. The workflow only updates version/checksums, not the `install` block.

## Step 7: Test Installation

Test the complete installation workflow.

### macOS Testing

```bash
# Install from Homebrew
brew install avihut/tap/daft

# Verify version
daft --version

# Test all symlinks exist
ls -l $(brew --prefix)/bin/git-worktree-*

# Test commands work
git worktree-clone --help
git worktree-checkout --help
git daft

# Clean up
brew uninstall daft
```

### Windows Testing

On a Windows machine:

```powershell
# Test PowerShell installer
irm https://github.com/avihut/daft/releases/latest/download/daft-installer.ps1 | iex

# Verify
daft --version
git-worktree-clone --help

# Or test MSI
# Download .msi from releases and run it
```

## Step 8: Announce Release

After verifying everything works:

1. **Update README badges** (if you add them)
2. **Social media announcement** (Twitter, Reddit, etc.)
3. **Close related GitHub issues** (e.g., Issue #3)
4. **Update project documentation** if needed

## Future Releases

For subsequent releases, the process is simpler:

```bash
# 1. Update version in Cargo.toml
vim Cargo.toml

# 2. Update CHANGELOG.md
vim CHANGELOG.md

# 3. Commit and tag
git add Cargo.toml CHANGELOG.md
git commit -m "chore: release v0.2.0"
git tag v0.2.0
git push origin main --tags

# 4. Wait for GitHub Actions (auto-updates formula!)
```

The Homebrew formula symlinks will persist automatically!

## Troubleshooting

### Release Workflow Fails

**Check:**
1. GitHub Actions logs for specific error
2. `HOMEBREW_TAP_TOKEN` is set correctly
3. Token has `repo` scope
4. Token hasn't expired

### Formula Not Updated

**Causes:**
- Token issue (check secret)
- Formula path wrong in `dist-workspace.toml`
- `publish-homebrew-formula` job failed

**Fix:**
1. Verify `dist-workspace.toml`:
   ```toml
   tap = "avihut/homebrew-tap"
   formula = "Formula/daft.rb"
   ```
2. Check token permissions
3. Review `publish-homebrew-formula` job logs

### Installation Fails

**Symptoms:**
- `brew install avihut/tap/daft` fails
- Checksum mismatch error

**Fix:**
1. Verify formula checksums match release artifacts
2. Check formula syntax: `brew audit --strict Formula/daft.rb`
3. Test local install: `brew install --build-from-source ./Formula/daft.rb`

## Advanced Configuration

### Add More Platforms

Edit `dist-workspace.toml`:

```toml
targets = [
  "aarch64-apple-darwin",
  "x86_64-apple-darwin",
  "x86_64-pc-windows-msvc",
  "x86_64-unknown-linux-gnu",    # Add Linux
  "aarch64-unknown-linux-gnu",   # Add Linux ARM
]
```

### Enable crates.io Publishing

Add to `dist-workspace.toml`:

```toml
publish-jobs = ["homebrew", "crates-io"]
```

Add `CARGO_REGISTRY_TOKEN` secret to GitHub.

### Change Install Path

Edit `dist-workspace.toml`:

```toml
install-path = "~/bin"  # Or other path
```

## Resources

- **cargo-dist docs**: https://opensource.axo.dev/cargo-dist/book/
- **Homebrew formula docs**: https://docs.brew.sh/Formula-Cookbook
- **GitHub Actions docs**: https://docs.github.com/en/actions
- **daft repository**: https://github.com/avihut/daft

## Summary

After completing this setup:
- ✅ Releases are fully automated
- ✅ Push a tag → binaries built → Homebrew formula updated → Release created
- ✅ Users can install with `brew install avihut/tap/daft` (macOS)
- ✅ Users can install with PowerShell script (Windows)
- ✅ Zero manual intervention required for releases

**Next steps:**
1. Create first release (v0.1.0)
2. Test installations on all platforms
3. Customize Homebrew formula with symlinks
4. Start using the automated workflow for future releases!
