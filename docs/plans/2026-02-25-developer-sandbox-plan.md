# Developer Sandbox Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to
> implement this plan task-by-task.

**Goal:** Add `mise run sandbox` and `mise run sandbox:clean` tasks that create
and manage per-worktree ephemeral test environments.

**Architecture:** Two bash scripts in `mise-tasks/sandbox/` that compute a
deterministic sandbox path from the worktree's absolute path, generate a
`.envrc` inside it, and use `DAFT_CD_FILE` to cd the shell into the sandbox.

**Tech Stack:** Bash, mise tasks, direnv, sha256sum/shasum

**Design doc:** `docs/plans/2026-02-25-developer-sandbox-design.md`

---

### Task 1: Create the `sandbox` mise task

**Files:**

- Create: `mise-tasks/sandbox/_default`

**Step 1: Create the sandbox task script**

```bash
#!/usr/bin/env bash
#MISE description="Create or enter a per-worktree test sandbox"
set -euo pipefail

# --- Configuration (override via env vars) ---
DAFT_SANDBOX_BASE="${DAFT_SANDBOX_BASE:-/tmp}"
DAFT_SANDBOX_GIT_NAME="${DAFT_SANDBOX_GIT_NAME:-Daft Developer}"
DAFT_SANDBOX_GIT_EMAIL="${DAFT_SANDBOX_GIT_EMAIL:-dev@daft.test}"

# --- Compute deterministic sandbox path ---
worktree_path="$(pwd)"
if command -v sha256sum &>/dev/null; then
    hash=$(echo -n "$worktree_path" | sha256sum | cut -c1-8)
else
    hash=$(echo -n "$worktree_path" | shasum -a 256 | cut -c1-8)
fi
sandbox_dir="${DAFT_SANDBOX_BASE}/daft-sandbox-${hash}"

# --- Detect shell for shell-init ---
shell_name="$(basename "${SHELL:-/bin/bash}")"
case "$shell_name" in
    bash|zsh|fish) ;;
    *) shell_name="bash" ;;
esac

# --- Create sandbox if it doesn't exist ---
if [ ! -d "$sandbox_dir" ]; then
    mkdir -p "$sandbox_dir"

    cat > "${sandbox_dir}/.envrc" <<ENVRC
# Daft development sandbox
# Generated by: mise run sandbox
# Worktree: ${worktree_path}

export PATH="${worktree_path}/target/release:\$PATH"

export GIT_AUTHOR_NAME="${DAFT_SANDBOX_GIT_NAME}"
export GIT_AUTHOR_EMAIL="${DAFT_SANDBOX_GIT_EMAIL}"
export GIT_COMMITTER_NAME="${DAFT_SANDBOX_GIT_NAME}"
export GIT_COMMITTER_EMAIL="${DAFT_SANDBOX_GIT_EMAIL}"

eval "\$(daft shell-init ${shell_name})"
ENVRC

    # Allow direnv if available
    if command -v direnv &>/dev/null; then
        direnv allow "$sandbox_dir"
    fi

    echo "Created sandbox at ${sandbox_dir}"
else
    echo "Sandbox exists at ${sandbox_dir}"
fi

# --- CD via DAFT_CD_FILE (same mechanism as daft commands) ---
if [ -n "${DAFT_CD_FILE:-}" ]; then
    echo "$sandbox_dir" > "$DAFT_CD_FILE"
fi
```

**Step 2: Make it executable**

Run: `chmod +x mise-tasks/sandbox/_default`

**Step 3: Verify the task appears in mise**

Run: `mise tasks | grep sandbox` Expected: `sandbox` listed with description
"Create or enter a per-worktree test sandbox"

**Step 4: Test sandbox creation**

Run: `mise run sandbox` Expected:

- Creates `/tmp/daft-sandbox-<hash>/`
- Creates `.envrc` inside it
- Prints "Created sandbox at /tmp/daft-sandbox-..."

**Step 5: Verify idempotency**

Run: `mise run sandbox` Expected: Prints "Sandbox exists at
/tmp/daft-sandbox-..." (no re-creation)

**Step 6: Verify `.envrc` contents**

Run: `cat /tmp/daft-sandbox-*/. envrc` Expected: Contains correct worktree path
in PATH, git identity, shell-init eval

**Step 7: Commit**

```bash
git add mise-tasks/sandbox/_default
git commit -m "feat: add sandbox mise task for per-worktree test environments"
```

---

### Task 2: Create the `sandbox:clean` mise task

**Files:**

- Create: `mise-tasks/sandbox/clean`

**Step 1: Create the clean task script**

```bash
#!/usr/bin/env bash
#MISE description="Remove the sandbox for this worktree"
set -euo pipefail

# --- Configuration ---
DAFT_SANDBOX_BASE="${DAFT_SANDBOX_BASE:-/tmp}"

# --- Compute deterministic sandbox path ---
worktree_path="$(pwd)"
if command -v sha256sum &>/dev/null; then
    hash=$(echo -n "$worktree_path" | sha256sum | cut -c1-8)
else
    hash=$(echo -n "$worktree_path" | shasum -a 256 | cut -c1-8)
fi
sandbox_dir="${DAFT_SANDBOX_BASE}/daft-sandbox-${hash}"

# --- Remove if exists ---
if [ -d "$sandbox_dir" ]; then
    rm -rf "$sandbox_dir"
    echo "Removed sandbox at ${sandbox_dir}"
else
    echo "No sandbox found for this worktree"
fi
```

**Step 2: Make it executable**

Run: `chmod +x mise-tasks/sandbox/clean`

**Step 3: Verify the task appears**

Run: `mise tasks | grep sandbox` Expected: Both `sandbox` and `sandbox:clean`
listed

**Step 4: Test cleanup**

Run: `mise run sandbox` (ensure sandbox exists) Run: `mise run sandbox:clean`
Expected: Prints "Removed sandbox at /tmp/daft-sandbox-..."

**Step 5: Verify directory is gone**

Run: `ls /tmp/daft-sandbox-*` (should show no matches for this worktree's hash)

**Step 6: Test clean when no sandbox exists**

Run: `mise run sandbox:clean` Expected: Prints "No sandbox found for this
worktree"

**Step 7: Commit**

```bash
git add mise-tasks/sandbox/clean
git commit -m "feat: add sandbox:clean mise task to remove worktree sandboxes"
```

---

### Task 3: Extract shared hash logic to avoid duplication

Both tasks duplicate the hash computation. Extract it to a shared helper.

**Files:**

- Create: `mise-tasks/sandbox/_lib.sh`
- Modify: `mise-tasks/sandbox/_default`
- Modify: `mise-tasks/sandbox/clean`

**Step 1: Create the shared library**

```bash
#!/usr/bin/env bash
# Shared utilities for sandbox tasks. Source this file, don't execute it.

sandbox_dir() {
    local base="${DAFT_SANDBOX_BASE:-/tmp}"
    local worktree_path
    worktree_path="$(pwd)"

    local hash
    if command -v sha256sum &>/dev/null; then
        hash=$(echo -n "$worktree_path" | sha256sum | cut -c1-8)
    else
        hash=$(echo -n "$worktree_path" | shasum -a 256 | cut -c1-8)
    fi

    echo "${base}/daft-sandbox-${hash}"
}
```

**Step 2: Update `_default` to source the library**

Replace the configuration + hash computation block in `_default` with:

```bash
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/_lib.sh"

sandbox_dir="$(sandbox_dir)"
worktree_path="$(pwd)"
```

Keep `DAFT_SANDBOX_GIT_NAME`, `DAFT_SANDBOX_GIT_EMAIL`, and the shell detection
in `_default` since only it needs them.

**Step 3: Update `clean` to source the library**

Replace the configuration + hash computation block in `clean` with:

```bash
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/_lib.sh"

sandbox_dir="$(sandbox_dir)"
```

**Step 4: Verify both tasks still work**

Run: `mise run sandbox:clean` (clean up from previous test) Run:
`mise run sandbox` (create fresh) Run: `mise run sandbox:clean` (remove)
Expected: Same behavior as before

**Step 5: Commit**

```bash
git add mise-tasks/sandbox/_lib.sh mise-tasks/sandbox/_default mise-tasks/sandbox/clean
git commit -m "refactor: extract shared hash logic into sandbox _lib.sh"
```

---

### Task 4: Test the full CD workflow end-to-end

This is a manual verification task, not code to commit.

**Step 1: Build daft first**

Run: `mise run dev:setup` Expected: Binary built, symlinks created in
`target/release/`

**Step 2: Test with DAFT_CD_FILE manually**

```bash
cd_file=$(mktemp)
DAFT_CD_FILE="$cd_file" mise run sandbox
cat "$cd_file"
rm "$cd_file"
```

Expected: The temp file contains the sandbox path (e.g.,
`/tmp/daft-sandbox-e7651f8a`)

**Step 3: Test with daft shell wrapper**

If you have `eval "$(daft shell-init zsh)"` in your shell, the `daft` function
wraps arbitrary commands. However, `mise run sandbox` is not routed through
daft.

For the CD to work automatically, you need a shell alias or function. Verify
this works:

```bash
# One-time setup (add to .zshrc if desired):
sandbox() {
    local cd_file
    cd_file=$(mktemp "${TMPDIR:-/tmp}/daft-cd.XXXXXX")
    DAFT_CD_FILE="$cd_file" mise run sandbox
    if [ -s "$cd_file" ]; then
        cd "$(cat "$cd_file")" || true
    fi
    rm -f "$cd_file"
}
```

Run: `sandbox` Expected: Shell CDs into the sandbox directory. `pwd` shows
`/tmp/daft-sandbox-<hash>`.

**Step 4: Verify direnv activates in sandbox**

Run: `cd /tmp/daft-sandbox-<hash>` Expected: direnv loads the `.envrc`, daft
commands are on PATH:

- `which daft` points to the worktree's `target/release/daft`
- `echo $GIT_AUTHOR_NAME` prints "Daft Developer"

**Step 5: Clean up**

Run: `mise run sandbox:clean`

---

### Task 5: Add the sandbox shell function to `docs/plans/` reference

Since `mise run sandbox` writes to `DAFT_CD_FILE` but mise tasks aren't routed
through the daft shell wrapper, document the recommended shell function.

**Files:**

- Modify: `docs/plans/2026-02-25-developer-sandbox-design.md`

**Step 1: Add a "Shell Integration" section to the design doc**

Append after the "CD Mechanism" section:

````markdown
## Shell Integration

The `mise run sandbox` task writes the sandbox path to `$DAFT_CD_FILE`, but mise
tasks are not routed through daft's shell wrapper. Add this function to your
shell config for automatic cd:

### Bash / Zsh

```bash
sandbox() {
    local cd_file
    cd_file=$(mktemp "${TMPDIR:-/tmp}/daft-cd.XXXXXX")
    DAFT_CD_FILE="$cd_file" mise run sandbox
    if [ -s "$cd_file" ]; then
        cd "$(cat "$cd_file")" || true
    fi
    rm -f "$cd_file"
}
```
````

### Fish

```fish
function sandbox
    set -l cd_file (mktemp (set -q TMPDIR; and echo $TMPDIR; or echo /tmp)"/daft-cd.XXXXXX")
    env DAFT_CD_FILE="$cd_file" mise run sandbox
    if test -s "$cd_file"
        cd (cat "$cd_file")
    end
    rm -f "$cd_file"
end
```

After adding, simply run `sandbox` from any daft worktree to create and enter
the sandbox.

````

**Step 2: Commit**

```bash
git add docs/plans/2026-02-25-developer-sandbox-design.md
git commit -m "docs: add shell integration instructions for sandbox"
````
