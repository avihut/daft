# Developer Sandbox for Daft Worktrees

## Problem

Testing daft during development requires a directory outside the project repo
(to avoid touching the repo itself). Currently this means maintaining a separate
test directory with a manually updated `.envrc` that points to the active
worktree's build output. Switching worktrees requires editing that file every
time.

## Solution

Two mise tasks -- `sandbox` and `sandbox:clean` -- that create and manage an
ephemeral, per-worktree test environment with a deterministic path.

## Behavior

### `mise run sandbox`

1. Compute sandbox path:
   `${DAFT_SANDBOX_BASE:-/tmp}/daft-sandbox-<first 8 chars of sha256(worktree absolute path)>`
2. If the directory does not exist:
   - Create it
   - Write a `.envrc` inside it (see Generated `.envrc` below)
   - Run `direnv allow` on it
   - Print: `Created sandbox at <path>`
3. If the directory already exists:
   - Regenerate `.envrc` (to pick up config changes)
   - Re-run `direnv allow`
   - Print: `Updated sandbox at <path>`
4. Write the sandbox path to `$DAFT_CD_FILE` (if set) so the shell wrapper CDs
   into it

### `mise run sandbox:clean`

1. Compute the same deterministic path
2. If it exists, `rm -rf` it and print: `Removed sandbox at <path>`
3. If not, print: `No sandbox found for this worktree`

## Configuration

| Variable                 | Default          | Purpose                                      |
| ------------------------ | ---------------- | -------------------------------------------- |
| `DAFT_SANDBOX_BASE`      | `/tmp`           | Base directory for sandbox creation          |
| `DAFT_SANDBOX_GIT_NAME`  | `Daft Developer` | `GIT_AUTHOR_NAME` and `GIT_COMMITTER_NAME`   |
| `DAFT_SANDBOX_GIT_EMAIL` | `dev@daft.test`  | `GIT_AUTHOR_EMAIL` and `GIT_COMMITTER_EMAIL` |

## Generated `.envrc`

```bash
# Daft development sandbox
# Generated by: mise run sandbox
# Worktree: /path/to/worktree

export PATH="/path/to/worktree/target/release:$PATH"

export GIT_AUTHOR_NAME="Daft Developer"
export GIT_AUTHOR_EMAIL="dev@daft.test"
export GIT_COMMITTER_NAME="Daft Developer"
export GIT_COMMITTER_EMAIL="dev@daft.test"

eval "$(daft shell-init zsh)"
```

The shell for `shell-init` is auto-detected from `$SHELL`.

## File Structure

```
mise-tasks/
  sandbox/
    _lib.sh     # shared sandbox_dir() function
    _default    # mise run sandbox
    clean       # mise run sandbox:clean
```

## CD Mechanism

The task writes the sandbox path to `$DAFT_CD_FILE` when the variable is set.
This is the same mechanism daft uses for all commands that change the working
directory. Users who have `eval "$(daft shell-init ...)"` in their shell config
get automatic cd via the `daft()` shell wrapper. A convenience shell function
could also wrap the mise call directly.

## Hash Determinism

The hash is computed from the worktree's absolute path, so:

- Same worktree always maps to the same sandbox directory
- Different worktrees get different sandboxes
- Sandbox survives shell restarts (until `/tmp` is cleaned or `sandbox:clean` is
  run)

## Shell Integration

The `mise run sandbox` task writes the sandbox path to `$DAFT_CD_FILE`, but mise
tasks are not routed through daft's shell wrapper. Add this function to your
shell config for automatic cd:

### Bash / Zsh

```bash
sandbox() {
    local cd_file
    cd_file=$(mktemp "${TMPDIR:-/tmp}/daft-cd.XXXXXX")
    DAFT_CD_FILE="$cd_file" mise run sandbox
    if [ -s "$cd_file" ]; then
        cd "$(cat "$cd_file")" || true
    fi
    rm -f "$cd_file"
}
```

### Fish

```fish
function sandbox
    set -l cd_file (mktemp (set -q TMPDIR; and echo $TMPDIR; or echo /tmp)"/daft-cd.XXXXXX")
    env DAFT_CD_FILE="$cd_file" mise run sandbox
    if test -s "$cd_file"
        cd (cat "$cd_file")
    end
    rm -f "$cd_file"
end
```

After adding, run `sandbox` from any daft worktree to create and enter the
sandbox.

## Dependencies

- `direnv` (optional): provides automatic env activation when re-entering the
  sandbox. Without it, the initial `mise run sandbox` still sets everything up,
  but re-entering the directory later does not auto-load the environment.
- `shasum` or `sha256sum`: for deterministic hash computation. Both are
  available on macOS and Linux by default.
