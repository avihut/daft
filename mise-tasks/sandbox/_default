#!/usr/bin/env bash
#MISE description="Create or enter a per-worktree test sandbox"
set -euo pipefail

# --- Configuration (override via env vars) ---
DAFT_SANDBOX_GIT_NAME="${DAFT_SANDBOX_GIT_NAME:-Daft Developer}"
DAFT_SANDBOX_GIT_EMAIL="${DAFT_SANDBOX_GIT_EMAIL:-dev@daft.test}"

# --- Compute deterministic sandbox path ---
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/_lib.sh"

sandbox_dir="$(sandbox_dir)"
# pwd returns the project root because mise always runs tasks from there
worktree_path="$(pwd)"

# --- Detect shell for shell-init ---
shell_name="$(basename "${SHELL:-/bin/bash}")"
case "$shell_name" in
    bash|zsh|fish) ;;
    *) shell_name="bash" ;;
esac

# --- Warn if release binary hasn't been built yet ---
if [ ! -d "${worktree_path}/target/release" ]; then
    echo "Warning: target/release not found â€” run 'mise run dev' first" >&2
fi

# --- Create sandbox directory if needed ---
if [ -d "$sandbox_dir" ]; then
    sandbox_verb="Updated"
else
    mkdir -p "$sandbox_dir"
    sandbox_verb="Created"
fi

# --- Always (re)generate .envrc to pick up config changes ---
cat > "${sandbox_dir}/.envrc" <<ENVRC
# Daft development sandbox
# Generated by: mise run sandbox
# Worktree: ${worktree_path}

export PATH="${worktree_path}/target/release:\$PATH"

export GIT_AUTHOR_NAME="${DAFT_SANDBOX_GIT_NAME}"
export GIT_AUTHOR_EMAIL="${DAFT_SANDBOX_GIT_EMAIL}"
export GIT_COMMITTER_NAME="${DAFT_SANDBOX_GIT_NAME}"
export GIT_COMMITTER_EMAIL="${DAFT_SANDBOX_GIT_EMAIL}"

eval "\$(daft shell-init ${shell_name})"
ENVRC

# Allow direnv if available
if command -v direnv &>/dev/null; then
    direnv allow "$sandbox_dir"
fi

echo "${sandbox_verb} sandbox at ${sandbox_dir}"

# --- CD via DAFT_CD_FILE (same mechanism as daft commands) ---
if [ -n "${DAFT_CD_FILE:-}" ]; then
    echo "$sandbox_dir" > "$DAFT_CD_FILE"
fi
