#!/usr/bin/env bash
#MISE description="Create or enter a per-worktree test sandbox"
set -euo pipefail

# --- Configuration (override via env vars) ---
DAFT_SANDBOX_BASE="${DAFT_SANDBOX_BASE:-/tmp}"
DAFT_SANDBOX_GIT_NAME="${DAFT_SANDBOX_GIT_NAME:-Daft Developer}"
DAFT_SANDBOX_GIT_EMAIL="${DAFT_SANDBOX_GIT_EMAIL:-dev@daft.test}"

# --- Compute deterministic sandbox path ---
worktree_path="$(pwd)"
if command -v sha256sum &>/dev/null; then
    hash=$(echo -n "$worktree_path" | sha256sum | cut -c1-8)
else
    hash=$(echo -n "$worktree_path" | shasum -a 256 | cut -c1-8)
fi
sandbox_dir="${DAFT_SANDBOX_BASE}/daft-sandbox-${hash}"

# --- Detect shell for shell-init ---
shell_name="$(basename "${SHELL:-/bin/bash}")"
case "$shell_name" in
    bash|zsh|fish) ;;
    *) shell_name="bash" ;;
esac

# --- Create sandbox if it doesn't exist ---
if [ ! -d "$sandbox_dir" ]; then
    mkdir -p "$sandbox_dir"

    cat > "${sandbox_dir}/.envrc" <<ENVRC
# Daft development sandbox
# Generated by: mise run sandbox
# Worktree: ${worktree_path}

export PATH="${worktree_path}/target/release:\$PATH"

export GIT_AUTHOR_NAME="${DAFT_SANDBOX_GIT_NAME}"
export GIT_AUTHOR_EMAIL="${DAFT_SANDBOX_GIT_EMAIL}"
export GIT_COMMITTER_NAME="${DAFT_SANDBOX_GIT_NAME}"
export GIT_COMMITTER_EMAIL="${DAFT_SANDBOX_GIT_EMAIL}"

eval "\$(daft shell-init ${shell_name})"
ENVRC

    # Allow direnv if available
    if command -v direnv &>/dev/null; then
        direnv allow "$sandbox_dir"
    fi

    echo "Created sandbox at ${sandbox_dir}"
else
    echo "Sandbox exists at ${sandbox_dir}"
fi

# --- CD via DAFT_CD_FILE (same mechanism as daft commands) ---
if [ -n "${DAFT_CD_FILE:-}" ]; then
    echo "$sandbox_dir" > "$DAFT_CD_FILE"
fi
