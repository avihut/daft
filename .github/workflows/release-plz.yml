name: Release-plz

on:
  push:
    branches: [master]

jobs:
  # Create GitHub releases for new versions (runs when release PR is merged)
  release-plz-release:
    name: Release-plz release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.WHEATLEY_BOT_APP_ID }}
          private-key: ${{ secrets.WHEATLEY_BOT_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run release-plz release
        uses: release-plz/action@v0.5
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

  # Create/update PR with version bump and changelog
  release-plz-pr:
    name: Release-plz PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    concurrency:
      group: release-plz-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.WHEATLEY_BOT_APP_ID }}
          private-key: ${{ secrets.WHEATLEY_BOT_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run release-plz release-pr
        id: release-plz
        uses: release-plz/action@v0.5
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      # Regenerate man pages to match the new version in Cargo.toml
      - name: Update man pages in release PR
        if: steps.release-plz.outputs.prs_created == 'true'
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Wait briefly for GitHub to propagate the PR and labels
          sleep 5

          # Get the release PR branch name with retry logic
          for i in 1 2 3; do
            PR_BRANCH=$(gh pr list --label release --json headRefName --jq '.[0].headRefName')
            if [ -n "$PR_BRANCH" ]; then
              break
            fi
            echo "Attempt $i: Release PR not found yet, waiting..."
            sleep 5
          done

          if [ -z "$PR_BRANCH" ]; then
            echo "No release PR found after retries, skipping man page update"
            exit 0
          fi

          echo "Found release PR branch: $PR_BRANCH"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Checkout the release PR branch
          git fetch origin "$PR_BRANCH"
          git checkout "$PR_BRANCH"

          # Regenerate man pages and CLI docs with new version
          cargo run --package xtask -- gen-man --output-dir=man
          cargo run --package xtask -- gen-cli-docs --output-dir=docs/cli

          # Check if anything changed
          if git diff --quiet man/ docs/cli/; then
            echo "Man pages and CLI docs are already up to date"
            exit 0
          fi

          # Commit and push the updated files
          git add man/ docs/cli/
          git commit -m "chore: regenerate man pages and CLI docs for new version"
          git push origin "$PR_BRANCH"
          echo "Man pages and CLI docs updated in release PR"
