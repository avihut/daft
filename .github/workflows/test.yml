name: Test Shell Scripts

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Git
      run: |
        git config --global user.name "Test User"
        git config --global user.email "test@example.com"
    
    - name: Make test scripts executable
      run: chmod +x tests/*.sh scripts/*
    
    - name: Add scripts to PATH
      run: echo "${{ github.workspace }}/scripts" >> $GITHUB_PATH
    
    - name: Run simple validation tests
      run: make test-simple
    
    - name: Run clone tests
      run: make test-clone
    
    - name: Run checkout tests
      run: make test-checkout
    
    - name: Run checkout-branch tests
      run: make test-checkout-branch
    
    - name: Run checkout-branch-from-default tests
      run: make test-checkout-branch-from-default
    
    - name: Run init tests
      run: make test-init
    
    - name: Run prune tests
      run: make test-prune
    
    - name: Run integration tests
      run: make test-all
    
    - name: Test individual script help
      run: |
        git worktree-clone --help || echo "Help command test"
        git worktree-checkout --help || echo "Help command test"
        git worktree-checkout-branch --help || echo "Help command test"
        git worktree-checkout-branch-from-default --help || echo "Help command test"
        git worktree-init --help || echo "Help command test"
        git worktree-prune --help || echo "Help command test"
    
    - name: Test script dependencies
      run: |
        echo "Testing required dependencies..."
        which git || { echo "Git not found"; exit 1; }
        which awk || { echo "AWK not found"; exit 1; }
        which basename || { echo "basename not found"; exit 1; }
        echo "All dependencies found"
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}
        path: |
          tests/test-results.log
        retention-days: 7
        if-no-files-found: ignore