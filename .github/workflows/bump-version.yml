name: Bump Version

on:
  push:
    branches: [master]

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.WHEATLEY_BOT_APP_ID }}
          private-key: ${{ secrets.WHEATLEY_BOT_PRIVATE_KEY }}

      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Get latest version tag
        id: get-version
        run: |
          # Get latest stable semver tag (exclude prereleases with hyphens)
          LATEST=$(git tag -l 'v*.*.*' | grep -v '-' | sort -V | tail -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
          echo "Latest version tag: $LATEST"

      - name: Check Cargo.toml for manual version bump
        id: check-manual
        run: |
          # Extract version from Cargo.toml
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          LATEST_TAG="${{ steps.get-version.outputs.latest }}"
          LATEST_VERSION="${LATEST_TAG#v}"

          echo "Cargo.toml version: $CARGO_VERSION"
          echo "Latest tag version: $LATEST_VERSION"

          # Compare - if Cargo.toml > latest tag, use Cargo.toml (manual bump)
          # Using sort -V to compare versions
          HIGHER=$(printf '%s\n%s' "$CARGO_VERSION" "$LATEST_VERSION" | sort -V | tail -n1)

          if [ "$HIGHER" = "$CARGO_VERSION" ] && [ "$CARGO_VERSION" != "$LATEST_VERSION" ]; then
            echo "version=v$CARGO_VERSION" >> "$GITHUB_OUTPUT"
            echo "Manual version bump detected: v$CARGO_VERSION"
          else
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "No manual version bump detected, will auto-increment patch"
          fi

      - name: Bump patch version
        id: bump
        if: steps.check-manual.outputs.version == ''
        run: |
          LATEST="${{ steps.get-version.outputs.latest }}"
          # Remove 'v' prefix, split into parts
          VERSION="${LATEST#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          # Bump patch
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Auto-bumped to: $NEW_VERSION"

      - name: Determine final version
        id: final
        run: |
          MANUAL="${{ steps.check-manual.outputs.version }}"
          AUTO="${{ steps.bump.outputs.version }}"
          VERSION="${MANUAL:-$AUTO}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Final version: $VERSION"

      - name: Install git-cliff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download --repo orhun/git-cliff --pattern 'git-cliff-*-x86_64-unknown-linux-gnu.tar.gz'
          tar xzf git-cliff-*-x86_64-unknown-linux-gnu.tar.gz
          sudo mv git-cliff-*/git-cliff /usr/local/bin/

      - name: Remove conflicting prerelease tags from HEAD
        run: |
          # git-cliff skips releases when a canary/beta tag points to the same commit
          # as the release tag. Remove any prerelease tags on HEAD to prevent this.
          HEAD_SHA=$(git rev-parse HEAD)
          echo "HEAD commit: $HEAD_SHA"

          # Find and delete any canary/beta tags pointing to HEAD
          for tag in $(git tag --points-at HEAD | grep -E '-(canary|beta)'); do
            echo "Removing conflicting prerelease tag: $tag"
            git tag -d "$tag"
            git push origin --delete "$tag" || echo "Failed to delete remote tag $tag (may not exist)"
          done

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          echo "Generating changelog for $VERSION"
          git cliff --config cliff.toml --tag "$VERSION" -o CHANGELOG.md
          echo "CHANGELOG.md updated"

      - name: Update Cargo.toml and create tag
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          # Remove 'v' prefix for Cargo.toml
          CARGO_VERSION="${VERSION#v}"

          git config user.name "wheatley-the-moronic-ci-bot[bot]"
          git config user.email "wheatley-the-moronic-ci-bot[bot]@users.noreply.github.com"

          # Update version in Cargo.toml
          sed -i "s/^version = .*/version = \"$CARGO_VERSION\"/" Cargo.toml

          # Stage CHANGELOG.md (always updated by git-cliff)
          git add CHANGELOG.md

          # Only commit Cargo.toml if it actually changed
          # (it won't change if this is a manual/major version bump from develop)
          if git diff --quiet Cargo.toml; then
            echo "Cargo.toml already at $CARGO_VERSION, skipping Cargo.toml"
          else
            git add Cargo.toml
          fi

          # Commit if there are staged changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: release $VERSION [skip ci]"
            git push origin master
          fi

          # Create and push tag
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

          echo "Created tag: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Trigger release workflow
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          echo "Triggering release workflow for $VERSION"
          gh workflow run release.yml -f tag="$VERSION"
