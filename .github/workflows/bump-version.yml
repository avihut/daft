name: Bump Version

on:
  push:
    branches: [master]

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.WHEATLEY_BOT_APP_ID }}
          private-key: ${{ secrets.WHEATLEY_BOT_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Get latest version tag
        id: get-version
        run: |
          # Get latest semver tag, default to v0.0.0 if none exist
          LATEST=$(git tag -l 'v*.*.*' | sort -V | tail -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
          echo "Latest version tag: $LATEST"

      - name: Check Cargo.toml for manual version bump
        id: check-manual
        run: |
          # Extract version from Cargo.toml
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          LATEST_TAG="${{ steps.get-version.outputs.latest }}"
          LATEST_VERSION="${LATEST_TAG#v}"

          echo "Cargo.toml version: $CARGO_VERSION"
          echo "Latest tag version: $LATEST_VERSION"

          # Compare - if Cargo.toml > latest tag, use Cargo.toml (manual bump)
          # Using sort -V to compare versions
          HIGHER=$(printf '%s\n%s' "$CARGO_VERSION" "$LATEST_VERSION" | sort -V | tail -n1)

          if [ "$HIGHER" = "$CARGO_VERSION" ] && [ "$CARGO_VERSION" != "$LATEST_VERSION" ]; then
            echo "version=v$CARGO_VERSION" >> "$GITHUB_OUTPUT"
            echo "Manual version bump detected: v$CARGO_VERSION"
          else
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "No manual version bump detected, will auto-increment patch"
          fi

      - name: Bump patch version
        id: bump
        if: steps.check-manual.outputs.version == ''
        run: |
          LATEST="${{ steps.get-version.outputs.latest }}"
          # Remove 'v' prefix, split into parts
          VERSION="${LATEST#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          # Bump patch
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Auto-bumped to: $NEW_VERSION"

      - name: Determine final version
        id: final
        run: |
          MANUAL="${{ steps.check-manual.outputs.version }}"
          AUTO="${{ steps.bump.outputs.version }}"
          VERSION="${MANUAL:-$AUTO}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Final version: $VERSION"

      - name: Update Cargo.toml and create tag
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          # Remove 'v' prefix for Cargo.toml
          CARGO_VERSION="${VERSION#v}"

          git config user.name "wheatley-the-moronic-ci-bot[bot]"
          git config user.email "wheatley-the-moronic-ci-bot[bot]@users.noreply.github.com"

          # Update version in Cargo.toml
          sed -i "s/^version = .*/version = \"$CARGO_VERSION\"/" Cargo.toml

          # Only commit if Cargo.toml actually changed
          # (it won't change if this is a manual/major version bump from develop)
          if git diff --quiet Cargo.toml; then
            echo "Cargo.toml already at $CARGO_VERSION, skipping commit"
          else
            git add Cargo.toml
            git commit -m "chore: release $VERSION"
            git push origin master
          fi

          # Create and push tag
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

          echo "Created tag: $VERSION"
