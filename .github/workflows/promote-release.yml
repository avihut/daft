name: Promote to Stable Release

on:
  workflow_dispatch:
    inputs:
      next_version:
        description: 'Next development version (e.g., 3.0.0)'
        required: true
        type: string

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.WHEATLEY_BOT_APP_ID }}
          private-key: ${{ secrets.WHEATLEY_BOT_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Get release version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Releasing version: $VERSION"

      - name: Configure git
        run: |
          git config user.name "wheatley-the-moronic-ci-bot[bot]"
          git config user.email "wheatley-the-moronic-ci-bot[bot]@users.noreply.github.com"

      - name: Fast-forward master to develop
        run: |
          # Fetch latest master
          git fetch origin master

          # Checkout master and fast-forward to develop
          # This requires develop to be rebased onto master first
          git checkout master
          git merge --ff-only develop

          # Push updated master
          git push origin master

      - name: Install git-cliff
        run: |
          curl -sSfL https://github.com/orhun/git-cliff/releases/latest/download/git-cliff-x86_64-unknown-linux-gnu.tar.gz | tar xz
          sudo mv git-cliff /usr/local/bin/

      - name: Generate release notes
        id: notes
        run: |
          # Get last stable tag
          LAST_STABLE=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]' | grep -v '-' | sort -V | tail -n1)

          echo "## What's Changed in v${{ steps.version.outputs.version }}" > release_notes.md
          echo "" >> release_notes.md

          # Use git-cliff for structured release notes
          if [ -n "$LAST_STABLE" ]; then
            git cliff --config cliff-prerelease.toml "${LAST_STABLE}"..HEAD >> release_notes.md || echo "No categorized changes."
          else
            git cliff --config cliff-prerelease.toml >> release_notes.md || echo "No categorized changes."
          fi

          echo "" >> release_notes.md
          cat release_notes.md

      - name: Bump develop to next version
        run: |
          git checkout develop

          # Rebase onto new master
          git rebase master

          # Update Cargo.toml to next version
          sed -i 's/^version = .*/version = "${{ inputs.next_version }}"/' Cargo.toml

          git add Cargo.toml
          git commit -m "chore: begin v${{ inputs.next_version }} development"

          # Force push is safe here: we just rebased develop onto master,
          # and --force-with-lease ensures we don't overwrite concurrent changes
          git push origin develop --force-with-lease

          echo "Bumped develop to v${{ inputs.next_version }}"

      - name: Create milestone for next version
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          NEXT_VERSION="${{ inputs.next_version }}"

          # Check if milestone already exists
          EXISTING=$(gh api "repos/${{ github.repository }}/milestones" --jq ".[] | select(.title==\"v${NEXT_VERSION}\") | .number")

          if [ -n "$EXISTING" ]; then
            echo "Milestone v${NEXT_VERSION} already exists (number: $EXISTING)"
          else
            gh api "repos/${{ github.repository }}/milestones" \
              -X POST \
              -f title="v${NEXT_VERSION}" \
              -f state="open" \
              -f description="Development milestone for v${NEXT_VERSION}"
            echo "Created milestone v${NEXT_VERSION}"
          fi
