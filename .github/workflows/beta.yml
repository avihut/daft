name: Beta Release

on:
  schedule:
    - cron: '0 10 1 * *'  # 1st of every month at 10:00 UTC
  workflow_dispatch:       # Manual trigger option

jobs:
  beta:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.WHEATLEY_BOT_APP_ID }}
          private-key: ${{ secrets.WHEATLEY_BOT_PRIVATE_KEY }}

      - uses: actions/checkout@v6
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Install git-cliff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download --repo orhun/git-cliff --pattern 'git-cliff-*-x86_64-unknown-linux-gnu.tar.gz'
          tar xzf git-cliff-*-x86_64-unknown-linux-gnu.tar.gz
          sudo mv git-cliff-*/git-cliff /usr/local/bin/

      - name: Check for changes since last beta
        id: check-changes
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          LAST_BETA=$(git tag -l "v${VERSION}-beta.*" | sort -V | tail -n1)

          if [ -z "$LAST_BETA" ]; then
            echo "No previous beta found, will create first beta"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "beta_number=1" >> "$GITHUB_OUTPUT"
          else
            # Check if there are commits since last beta
            COMMITS=$(git rev-list ${LAST_BETA}..HEAD --count)
            if [ "$COMMITS" -gt 0 ]; then
              echo "Found $COMMITS commits since $LAST_BETA"
              echo "has_changes=true" >> "$GITHUB_OUTPUT"
              BETA_NUM=$(echo "$LAST_BETA" | sed 's/.*beta\.//')
              echo "beta_number=$((BETA_NUM + 1))" >> "$GITHUB_OUTPUT"
            else
              echo "No changes since $LAST_BETA, skipping beta release"
              echo "has_changes=false" >> "$GITHUB_OUTPUT"
            fi
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create beta tag and release
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          VERSION="${{ steps.check-changes.outputs.version }}"
          BETA_NUM="${{ steps.check-changes.outputs.beta_number }}"
          BETA_TAG="v${VERSION}-beta.${BETA_NUM}"

          # Generate release notes with git-cliff
          echo "Generating release notes..."

          # Find reference point for changelog
          LAST_BETA=$(git tag -l "v${VERSION}-beta.*" | sort -V | tail -n1)
          LAST_STABLE=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]' | grep -v '-' | sort -V | tail -n1)

          if [ -n "$LAST_BETA" ]; then
            echo "Generating changelog from $LAST_BETA to HEAD"
            git cliff --config cliff-prerelease.toml "${LAST_BETA}"..HEAD > /tmp/cliff_notes.md || echo ""
          elif [ -n "$LAST_STABLE" ]; then
            echo "Generating changelog from $LAST_STABLE to HEAD"
            git cliff --config cliff-prerelease.toml "${LAST_STABLE}"..HEAD > /tmp/cliff_notes.md || echo ""
          else
            echo "Generating changelog for all commits"
            git cliff --config cliff-prerelease.toml --unreleased > /tmp/cliff_notes.md || echo ""
          fi

          # Build final release notes
          cat > /tmp/release_notes.md << 'NOTES'
          Beta release from `develop` branch.

          **This is a pre-release for testing purposes.**

          To install this beta version:
          ```bash
          cargo install --git https://github.com/avihut/daft --tag $BETA_TAG
          ```

          Commit: COMMIT_SHA
          NOTES
          sed -i "s/COMMIT_SHA/${{ github.sha }}/" /tmp/release_notes.md
          sed -i "s/\$BETA_TAG/$BETA_TAG/" /tmp/release_notes.md
          sed -i 's/^          //' /tmp/release_notes.md

          # Append git-cliff output if it has content
          if [ -s /tmp/cliff_notes.md ]; then
            echo "---" >> /tmp/release_notes.md
            echo "" >> /tmp/release_notes.md
            echo "## Changes" >> /tmp/release_notes.md
            echo "" >> /tmp/release_notes.md
            cat /tmp/cliff_notes.md >> /tmp/release_notes.md
          fi

          git config user.name "wheatley-the-moronic-ci-bot[bot]"
          git config user.email "wheatley-the-moronic-ci-bot[bot]@users.noreply.github.com"
          git tag -a "$BETA_TAG" -m "Beta release $BETA_TAG"
          git push origin "$BETA_TAG"

          # Create GitHub prerelease
          gh release create "$BETA_TAG" \
            --prerelease \
            --title "Beta: $BETA_TAG" \
            --notes-file /tmp/release_notes.md

          echo "Created beta release: $BETA_TAG"
