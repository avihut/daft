name: Test Homebrew Installation

on:
  # Trigger after Release workflow completes successfully
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to test (e.g., 1.0.9). If empty, uses latest release.'
        required: false
        type: string

jobs:
  test-homebrew:
    runs-on: macos-latest
    # Only run if Release succeeded or manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Get expected version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # Manual trigger with specific version
            VERSION="${{ inputs.version }}"
          else
            # Get version from latest GitHub release
            LATEST_TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName --jq '.[0].tagName')
            VERSION="${LATEST_TAG#v}"  # Remove 'v' prefix
          fi
          echo "Expected version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Wait for Homebrew tap to have correct version
        run: |
          EXPECTED="${{ steps.version.outputs.version }}"
          echo "Waiting for Homebrew tap to have version $EXPECTED..."

          for i in {1..15}; do
            echo ""
            echo "=== Attempt $i/15 ==="

            # Tap and update
            brew tap avihut/daft 2>/dev/null || true
            brew update 2>/dev/null || true

            # Get current version in tap
            CURRENT=$(brew info avihut/daft/daft --json 2>/dev/null | jq -r '.[0].versions.stable' 2>/dev/null || echo "unknown")
            echo "Tap has version: $CURRENT"
            echo "Expected version: $EXPECTED"

            if [ "$CURRENT" = "$EXPECTED" ]; then
              echo "Version match! Proceeding with installation."
              break
            fi

            if [ $i -eq 15 ]; then
              echo ""
              echo "ERROR: Timed out waiting for version $EXPECTED"
              echo "Homebrew tap still has version $CURRENT"
              exit 1
            fi

            echo "Version mismatch, waiting 30s before retry..."
            sleep 30
          done

      - name: Install via Homebrew
        run: |
          echo "Installing daft..."
          brew install avihut/daft/daft

      - name: Verify installed version matches expected
        run: |
          EXPECTED="${{ steps.version.outputs.version }}"
          INSTALLED=$(daft --version | awk '{print $2}')

          echo "Expected version: $EXPECTED"
          echo "Installed version: $INSTALLED"

          if [ "$INSTALLED" != "$EXPECTED" ]; then
            echo "ERROR: Version mismatch!"
            exit 1
          fi
          echo "Version verified!"

      - name: Verify installation
        run: |
          echo "=== Verifying daft installation ==="

          # Verify all commands are available in PATH
          echo ""
          echo "Command locations:"
          for cmd in daft git-worktree-clone git-worktree-checkout git-worktree-checkout-branch \
                     git-worktree-checkout-branch-from-default git-worktree-init \
                     git-worktree-prune git-worktree-carry git-worktree-fetch \
                     git-worktree-flow-adopt git-worktree-flow-eject git-daft; do
            echo "  $cmd: $(which $cmd)"
          done

          # Verify help commands work
          echo ""
          echo "Testing --help for all commands..."
          for cmd in daft git-worktree-clone git-worktree-checkout git-worktree-checkout-branch \
                     git-worktree-checkout-branch-from-default git-worktree-init \
                     git-worktree-prune git-worktree-carry git-worktree-fetch \
                     git-worktree-flow-adopt git-worktree-flow-eject git-daft; do
            echo "  $cmd --help..."
            $cmd --help > /dev/null || { echo "FAILED: $cmd --help"; exit 1; }
          done

          echo ""
          echo "All commands verified!"

      - name: Verify man pages
        run: |
          echo "=== Verifying man pages ==="

          # Man pages are generated for git-worktree-* commands and daft-release-notes
          for page in git-worktree-clone git-worktree-checkout git-worktree-checkout-branch \
                      git-worktree-checkout-branch-from-default git-worktree-init \
                      git-worktree-prune git-worktree-carry git-worktree-fetch \
                      git-worktree-flow-adopt git-worktree-flow-eject daft-release-notes; do
            echo "  Checking man $page..."
            man -w $page > /dev/null 2>&1 || { echo "FAILED: man page not found for $page"; exit 1; }
          done

          echo "All man pages found!"

      - name: Test basic functionality
        run: |
          echo "=== Testing basic functionality ==="

          # Set up git identity for test operations (in test directory only)
          cd /tmp
          mkdir -p test-daft && cd test-daft

          # Create a bare repository to use as remote
          echo "Creating test remote repository..."
          git init --bare remote.git

          # Initialize it with a commit so clone works
          git clone remote.git temp-init
          cd temp-init
          git config user.name "Test User"
          git config user.email "test@example.com"
          echo "# Test Project" > README.md
          git add README.md
          git commit -m "Initial commit"
          git push origin HEAD
          cd ..
          rm -rf temp-init

          # Test git-worktree-clone
          echo ""
          echo "Testing git worktree-clone..."
          git worktree-clone /tmp/test-daft/remote.git test-clone

          # Verify the structure
          echo "Verifying clone structure..."
          test -d test-clone/.git || { echo "FAILED: .git directory not found"; exit 1; }
          # Find the worktree directory (could be main or master)
          WORKTREE_DIR=$(ls -d test-clone/*/ 2>/dev/null | head -1)
          test -n "$WORKTREE_DIR" || { echo "FAILED: No worktree directory found"; exit 1; }
          test -f "${WORKTREE_DIR}README.md" || { echo "FAILED: README.md not found in worktree"; exit 1; }

          echo ""
          echo "=== All tests passed! ==="
          echo "Homebrew installation is working correctly."

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/test-daft
