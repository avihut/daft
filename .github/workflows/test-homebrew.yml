name: Test Homebrew Installation

on:
  # Triggered by homebrew-tap repo when formula is updated
  repository_dispatch:
    types: [homebrew-tap-formula-updated]
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      version:
        description: "Version to test (e.g., 1.0.9)"
        required: true
        type: string

jobs:
  test-homebrew:
    runs-on: macos-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Get expected version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "Expected version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install via Homebrew
        run: |
          EXPECTED="${{ steps.version.outputs.version }}"
          echo "Installing daft (expecting version $EXPECTED)..."

          # Tap and install
          brew tap avihut/tap
          brew install avihut/tap/daft

          # Verify correct version was installed
          INSTALLED=$(daft --version | awk '{print $2}')
          echo "Installed version: $INSTALLED"

          if [ "$INSTALLED" != "$EXPECTED" ]; then
            echo "ERROR: Version mismatch! Expected $EXPECTED but got $INSTALLED"
            exit 1
          fi
          echo "Version verified!"

      - name: Verify installation
        run: |
          echo "=== Verifying daft installation ==="

          # Verify all commands are available in PATH
          echo ""
          echo "Command locations:"
          for cmd in daft git-worktree-clone git-worktree-checkout git-worktree-init \
                     git-worktree-branch git-worktree-branch-delete \
                     git-worktree-prune git-worktree-carry git-worktree-fetch \
                     git-worktree-flow-adopt git-worktree-flow-eject git-daft; do
            echo "  $cmd: $(which $cmd)"
          done

          # Verify help commands work
          echo ""
          echo "Testing --help for all commands..."
          for cmd in daft git-worktree-clone git-worktree-checkout git-worktree-init \
                     git-worktree-branch git-worktree-branch-delete \
                     git-worktree-prune git-worktree-carry git-worktree-fetch \
                     git-worktree-flow-adopt git-worktree-flow-eject git-daft; do
            echo "  $cmd --help..."
            $cmd --help > /dev/null || { echo "FAILED: $cmd --help"; exit 1; }
          done

          echo ""
          echo "All commands verified!"

      - name: Verify man pages
        run: |
          echo "=== Verifying man pages ==="

          # Man pages are generated for git-worktree-* commands and daft-release-notes
          for page in git-worktree-clone git-worktree-checkout \
                      git-worktree-init git-worktree-branch git-worktree-branch-delete \
                      git-worktree-prune git-worktree-carry git-worktree-fetch \
                      git-worktree-flow-adopt git-worktree-flow-eject daft-release-notes; do
            echo "  Checking man $page..."
            man -w $page > /dev/null 2>&1 || { echo "FAILED: man page not found for $page"; exit 1; }
          done

          echo "All man pages found!"

      - name: Test basic functionality
        run: |
          echo "=== Testing basic functionality ==="

          # Set up git identity for test operations (in test directory only)
          cd /tmp
          mkdir -p test-daft && cd test-daft

          # Create a bare repository to use as remote
          echo "Creating test remote repository..."
          git init --bare remote.git

          # Initialize it with a commit so clone works
          git clone remote.git temp-init
          cd temp-init
          git config user.name "Test User"
          git config user.email "test@example.com"
          echo "# Test Project" > README.md
          git add README.md
          git commit -m "Initial commit"
          git push origin HEAD
          cd ..
          rm -rf temp-init

          # Test git-worktree-clone
          echo ""
          echo "Testing git worktree-clone..."
          git worktree-clone /tmp/test-daft/remote.git

          # Verify the structure (directory is named after the repo without .git suffix)
          echo "Verifying clone structure..."
          test -d remote/.git || { echo "FAILED: .git directory not found"; exit 1; }
          # Find the worktree directory (could be main or master)
          WORKTREE_DIR=$(ls -d remote/*/ 2>/dev/null | head -1)
          test -n "$WORKTREE_DIR" || { echo "FAILED: No worktree directory found"; exit 1; }
          test -f "${WORKTREE_DIR}README.md" || { echo "FAILED: README.md not found in worktree"; exit 1; }

          echo ""
          echo "=== All tests passed! ==="
          echo "Homebrew installation is working correctly."

      - name: Cleanup
        if: always()
        run: |
          rm -rf /tmp/test-daft
